<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠n d·∫°ng Bi·ªÉn s·ªë Xe Vi·ªát Nam</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Nh·∫≠n d·∫°ng Bi·ªÉn s·ªë Xe</h1>
                <p class="subtitle">H·ªá th·ªëng nh·∫≠n d·∫°ng bi·ªÉn s·ªë t·ª± ƒë·ªông s·ª≠ d·ª•ng AI</p>
            </div>
        </header>

        <main>
            <div class="upload-section">
                <div class="upload-box" id="uploadBox">
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                    <div class="upload-content" id="uploadContent">
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>
                        <p class="upload-text">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c <span class="link">ch·ªçn file</span></p>
                        <p class="hint">H·ªó tr·ª£: JPG, PNG, JPEG (t·ªëi ƒëa 16MB)</p>
                    </div>
                </div>
                <button id="processBtn" class="btn btn-primary" disabled>
                    <span id="btnText">Nh·∫≠n d·∫°ng Bi·ªÉn s·ªë</span>
                    <span id="btnLoader" class="loader" style="display: none;"></span>
                </button>
            </div>

            <div id="resultsSection" class="results-section" style="display: none;">
                <div class="result-card">
                    <div class="result-header">
                        <h2>üéØ K·∫øt qu·∫£ nh·∫≠n d·∫°ng</h2>
                        <span id="plateCount" class="badge">0 bi·ªÉn s·ªë</span>
                    </div>
                    <div class="result-content">
                        <div class="plate-text" id="resultText"></div>
                    </div>
                </div>

                <!-- C√°c b∆∞·ªõc x·ª≠ l√Ω ·∫£nh -->
                <div class="processing-steps-section">
                    <h2 class="section-title">üîÑ C√°c b∆∞·ªõc x·ª≠ l√Ω ·∫£nh</h2>
                    <p class="section-subtitle">Qu√° tr√¨nh ph√°t hi·ªán v√† nh·∫≠n d·∫°ng bi·ªÉn s·ªë qua t·ª´ng b∆∞·ªõc</p>
                    
                    <div class="steps-timeline">
                        <!-- B∆∞·ªõc 1: ·∫¢nh g·ªëc -->
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <h3>·∫¢nh g·ªëc</h3>
                            <p class="step-desc">·∫¢nh ƒë·∫ßu v√†o sau khi resize v·ªÅ k√≠ch th∆∞·ªõc chu·∫©n</p>
                            <div class="image-wrapper">
                                <img id="stepOriginal" src="" alt="·∫¢nh g·ªëc">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 2: Grayscale -->
                        <div class="step-card">
                            <div class="step-number">2</div>
                            <h3>Chuy·ªÉn ƒë·ªïi Grayscale</h3>
                            <p class="step-desc">Chuy·ªÉn sang HSV v√† tr√≠ch xu·∫•t k√™nh Value (ƒë·ªô s√°ng)</p>
                            <div class="image-wrapper">
                                <img id="stepGrayscale" src="" alt="Grayscale">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 3: TƒÉng t∆∞∆°ng ph·∫£n -->
                        <div class="step-card">
                            <div class="step-number">3</div>
                            <h3>TƒÉng ƒë·ªô t∆∞∆°ng ph·∫£n</h3>
                            <p class="step-desc">Top Hat + Black Hat morphology</p>
                            <div class="image-wrapper">
                                <img id="stepContrast" src="" alt="Contrast">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 4: L√†m m·ªãn -->
                        <div class="step-card">
                            <div class="step-number">4</div>
                            <h3>L√†m m·ªãn ·∫£nh</h3>
                            <p class="step-desc">Gaussian Blur ƒë·ªÉ gi·∫£m nhi·ªÖu</p>
                            <div class="image-wrapper">
                                <img id="stepBlurred" src="" alt="Blurred">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 5: Nh·ªã ph√¢n h√≥a -->
                        <div class="step-card">
                            <div class="step-number">5</div>
                            <h3>Nh·ªã ph√¢n h√≥a</h3>
                            <p class="step-desc">Adaptive Threshold ƒë·ªÉ t√°ch n·ªÅn v√† k√Ω t·ª±</p>
                            <div class="image-wrapper">
                                <img id="stepThreshold" src="" alt="Threshold">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 6: Ph√°t hi·ªán c·∫°nh -->
                        <div class="step-card">
                            <div class="step-number">6</div>
                            <h3>Ph√°t hi·ªán c·∫°nh</h3>
                            <p class="step-desc">Canny Edge Detection ƒë·ªÉ t√¨m ƒë∆∞·ªùng vi·ªÅn</p>
                            <div class="image-wrapper">
                                <img id="stepCanny" src="" alt="Canny">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 7: Dilation -->
                        <div class="step-card">
                            <div class="step-number">7</div>
                            <h3>Dilation</h3>
                            <p class="step-desc">N·ªëi c√°c c·∫°nh b·ªã ƒë·ª©t ƒëo·∫°n</p>
                            <div class="image-wrapper">
                                <img id="stepDilated" src="" alt="Dilated">
                            </div>
                        </div>

                        <!-- B∆∞·ªõc 8: Ph√°t hi·ªán contour -->
                        <div class="step-card highlight">
                            <div class="step-number">8</div>
                            <h3>Ph√°t hi·ªán bi·ªÉn s·ªë</h3>
                            <p class="step-desc">T√¨m v√† khoanh v√πng bi·ªÉn s·ªë (t·ª© gi√°c)</p>
                            <div class="image-wrapper">
                                <img id="stepContours" src="" alt="Contours">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bi·ªÉn s·ªë ƒë√£ c·∫Øt -->
                <div class="detected-plates-section">
                    <h2 class="section-title">üöó Bi·ªÉn s·ªë ƒë√£ nh·∫≠n d·∫°ng</h2>
                    <div id="plateImagesContainer" class="plate-images"></div>
                </div>
            </div>

            <div id="errorSection" class="error-card" style="display: none;">
                <div class="error-icon">‚ö†</div>
                <p id="errorText"></p>
            </div>
        </main>

        <footer>
            <p>H·ªá th·ªëng nh·∫≠n d·∫°ng bi·ªÉn s·ªë xe s·ª≠ d·ª•ng OpenCV v√† Machine Learning</p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadBox = document.getElementById('uploadBox');
        const uploadContent = document.getElementById('uploadContent');
        const processBtn = document.getElementById('processBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const resultsSection = document.getElementById('resultsSection');
        const errorSection = document.getElementById('errorSection');
        const resultText = document.getElementById('resultText');
        const plateCount = document.getElementById('plateCount');
        const detectedImage = document.getElementById('detectedImage');
        const plateImagesContainer = document.getElementById('plateImagesContainer');
        const errorText = document.getElementById('errorText');

        let selectedFile = null;

        uploadBox.addEventListener('click', () => fileInput.click());

        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('drag-over');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('drag-over');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.type.startsWith('image/')) {
                showError('Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá (JPG, PNG, JPEG)');
                return;
            }

            selectedFile = file;
            processBtn.disabled = false;

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadContent.innerHTML = `
                    <div class="preview-container">
                        <img src="${e.target.result}" alt="Preview" class="preview-image">
                        <div class="preview-info">
                            <p class="file-name">${file.name}</p>
                            <p class="hint">Click ƒë·ªÉ ch·ªçn ·∫£nh kh√°c</p>
                        </div>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            processBtn.disabled = true;
            btnText.textContent = 'ƒêang x·ª≠ l√Ω...';
            btnLoader.style.display = 'inline-block';
            resultsSection.style.display = 'none';
            errorSection.style.display = 'none';

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                const response = await fetch('/api/recognize', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showResults(data);
                } else {
                    showError(data.error || 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh');
                }
            } catch (error) {
                showError('L·ªói k·∫øt n·ªëi: ' + error.message);
            } finally {
                processBtn.disabled = false;
                btnText.textContent = 'Nh·∫≠n d·∫°ng Bi·ªÉn s·ªë';
                btnLoader.style.display = 'none';
            }
        });

        function showResults(data) {
            if (data.results && data.results.length > 0) {
                resultText.innerHTML = data.results.map(result => 
                    `<span class="plate-badge">${result}</span>`
                ).join('');
                plateCount.textContent = `${data.count} bi·ªÉn s·ªë`;
            } else {
                resultText.innerHTML = '<span class="plate-badge no-plate">Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c bi·ªÉn s·ªë</span>';
                plateCount.textContent = '0 bi·ªÉn s·ªë';
            }

            // Hi·ªÉn th·ªã c√°c b∆∞·ªõc x·ª≠ l√Ω ·∫£nh
            if (data.processing_steps) {
                const steps = data.processing_steps;
                
                if (steps.original) {
                    document.getElementById('stepOriginal').src = 'data:image/jpeg;base64,' + steps.original;
                }
                if (steps.grayscale) {
                    document.getElementById('stepGrayscale').src = 'data:image/jpeg;base64,' + steps.grayscale;
                }
                if (steps.contrast) {
                    document.getElementById('stepContrast').src = 'data:image/jpeg;base64,' + steps.contrast;
                }
                if (steps.blurred) {
                    document.getElementById('stepBlurred').src = 'data:image/jpeg;base64,' + steps.blurred;
                }
                if (steps.threshold) {
                    document.getElementById('stepThreshold').src = 'data:image/jpeg;base64,' + steps.threshold;
                }
                if (steps.canny) {
                    document.getElementById('stepCanny').src = 'data:image/jpeg;base64,' + steps.canny;
                }
                if (steps.dilated) {
                    document.getElementById('stepDilated').src = 'data:image/jpeg;base64,' + steps.dilated;
                }
                if (steps.contours) {
                    document.getElementById('stepContours').src = 'data:image/jpeg;base64,' + steps.contours;
                }
            }

            // Hi·ªÉn th·ªã bi·ªÉn s·ªë ƒë√£ c·∫Øt v√† nh·∫≠n d·∫°ng
            plateImagesContainer.innerHTML = '';
            if (data.plate_images && data.plate_images.length > 0) {
                data.plate_images.forEach((plateImg, index) => {
                    const plateDiv = document.createElement('div');
                    plateDiv.className = 'plate-card';
                    plateDiv.innerHTML = `
                        <h4>Bi·ªÉn s·ªë ${index + 1}</h4>
                        <div class="plate-text-small">${data.results[index] || 'N/A'}</div>
                        <div class="image-wrapper">
                            <img src="data:image/jpeg;base64,${plateImg}" alt="Plate ${index + 1}">
                        </div>
                    `;
                    plateImagesContainer.appendChild(plateDiv);
                });
            }

            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            errorText.textContent = message;
            errorSection.style.display = 'flex';
            errorSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
